<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Icons & Fonts -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Main stylesheet -->

  <link rel="icon" type="image/png" href="{{url_for('static', filename='./images/deped_seal.png')}}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='./css/admin_dashboard.css') }}" />
</head>

<body>

  <!-- SITE BANNER -->
  <header class="site-banner" role="banner">
    <div class="banner-top">
      <!-- Left group: logo and text -->
      <div class="banner-left-group">
        <img src="{{ url_for('static', filename='images/deped_seal.png') }}" alt="DepEd Logo" class="banner-logo" />
        <div class="banner-left-text">
          <p class="sub-banner-dept">Schools Division of Laoag City</p>
          <p class="sub-banner-region">Region I – Ilocos Region</p>
        </div>
      </div>

      <!-- Centered title -->
      <div class="banner-text">
        <h1>DEPARTMENT OF EDUCATION</h1>
        <p class="banner-subtitle">Human Resource Merit Promotion and Selection Board</p>
      </div>
      <a href="{{ url_for('admin_logout') }}" class="banner-logout">Logout</a>
    </div>
    <!-- Add toggle button for mobile navigation -->
  </header>

          {% with msgs = get_flashed_messages(category_filter=["error"]) %}
          {% for m in msgs %}
            <div class="flash">{{ m }}</div>
          {% endfor %}
        {% endwith %}
        
  <!-- MAIN CONTAINER BOX -->
  <main class="form-container" role="main">

    <div class="tab-nav">
      <a href="#create_interview">Create Interview</a>
      <a href="#existing_interview">Existing Interview</a>
    </div>

    <div class="dashboard-box">
      <!-- Create Interview Panel -->
      <section class="card panel-create" aria-labelledby="create-heading" id="create_interview">
        <h2 id="create-heading">Create Interview</h2>
        <form method="post" action="{{ url_for('create_interview') }}">

          <label for="interview_type">Interview Type</label>
          <select id="interview_type" name="interview_type" required>
            <option disabled selected>– select –</option>
            <option value="non teaching">Non-Teaching</option>
            <option value="teacher 1">Teacher 1</option>
            <option value="school administration">School Administration</option>
            <option value="related teaching">Related Teaching</option>
            <option value="higher teaching">Higher Teaching</option>
          </select>

          <!-- Add this after the interview_type select in your form -->
          <div id="sg_level_container" style="display: none;">
            <label for="sg_level">Job Group/SG-Level</label>
            <select id="sg_level" name="sg_level" required>
              <option disabled selected>– select –</option>
            </select>
          </div>


          <label for="baseline_education">Baseline Education</label>
          <select id="baseline_education" name="baseline_education" required>
            <option disabled selected>– select –</option>
            {% for k, v in ed_labels.items() %}
            <option value="{{ k }}">{{ v }}</option>
            {% endfor %}
          </select>

          <div id="weight_edu_container" style="display: none;">
            <label for="weight_edu">Weight Edu</label>
            <input type="number" id="weight_edu" name="weight_edu" min="0" step="5" required />
          </div>

          <label for="baseline_experience">Baseline Experience</label>
          <select id="baseline_experience" name="baseline_experience" required>
            <option disabled selected>– select –</option>
            {% for k, v in ex_labels.items() %}
            <option value="{{ k }}">{{ v }}</option>
            {% endfor %}
          </select>

          <div id="weight_exp_container" style="display: none;">
            <label for="weight_exp">Weight Experience</label>
            <input type="number" id="weight_exp" name="weight_exp" min="0" step="5" required />
          </div>

          <label for="baseline_training">Baseline Training</label>
          <select id="baseline_training" name="baseline_training" required>
            <option disabled selected>– select –</option>
            {% for k, v in tr_labels.items() %}
            <option value="{{ k }}">{{ v }}</option>
            {% endfor %}
          </select>

          <div id="weight_trn_container" style="display: none;">
            <label for="weight_trn">Weight Training</label>
            <input type="number" id="weight_trn" name="weight_trn" min="0" step="5" required />
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-submit">Create Interview</button>
          </div>
        </form>
      </section>

      <!-- Existing Interviews Panel -->
      <section class="card panel-list" aria-labelledby="list-heading" id="existing_interview">
        <h2 id="list-heading">Existing Interviews</h2>
        <div class="interview-controls">
          <input type="text" id="searchBar" placeholder="Search interview" onkeyup="filterInterviews()">
          <button class="sort-btn" onclick="sortByDate()">⇅ Sort by Date</button>
        </div>
        <table class="qual-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Baselines</th>
              <th>#Eval</th>
              <th>#Applicants</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            {% for iv in interviews %}
            <tr>
              <td>{{ iv.id }}</td>
              <td>{{ iv.date }} </td>
              <td>
                Education: {{ ed_labels[iv.base_edu ~ ''] }} <br>
                Experience: {{ ex_labels[iv.base_exp ~ ''] }} <br>
                Training: {{ tr_labels[iv.base_trn ~ ''] }}
              </td>
              <td>{{ iv.evaluator_tokens|length }}</td>
              <td>{{ iv.applicants|length }}</td>
              <td>
                <div class="btn-group"></div>
                <a href="{{ url_for('admin_interview_detail', iid=iv.id) }}"
                  class="btn-submit btn-submit--view">View</a>
                <a href="{{ url_for('update_interview', iid=iv.id) }}" class="btn-submit btn-submit--update">Update</a>
                <a href="{{ url_for('delete_interview', iid=iv.id) }}" class="btn-submit btn-submit--delete confirm-delete ">Delete</a>
    </div>
    </td>
    </tr>
    {% endfor %}
    </tbody>
    </table>
    </section>
    </div>

    <div id="delete-modal" class="modal">
      <div class="modal-content">
        <p>Are you sure you want to delete this interview?</p>
        <div class="modal-actions">
          <button id="confirm-delete" class="btn-submit btn-submit--delete">Yes, delete</button>
          <button id="cancel-delete" class="btn-submit btn-submit--view">Cancel</button>
        </div>
      </div>
    </div>

  </main>

  <!-- SITE FOOTER -->
  <footer class="admin-footer" role="contentinfo">
    <div class="footer-content">
      <div class="footer-logos">
        <img src="{{ url_for('static', filename='images/deped_logo.png') }}" alt="DepEd Logo" />
      </div>
      <div class="footer-links">
        <a href="mailto:laoag.city@deped.gov.ph"><i class="fas fa-envelope"></i>laoag.city@deped.gov.ph</a>
        <a href="https://www.facebook.com/depedtayolaoagcity" target="_blank"><i
            class="fab fa-facebook-square"></i>facebook.com/depedtayolaoagcity</a>
        <a href="https://www.depedlaoagcity.com" target="_blank"><i class="fas fa-globe"></i>depedlaoagcity.com</a>
      </div>
    </div>
  </footer>
  <script>
    // Static weight map
    const WEIGHT_STRUCTURE = {
      "teacher 1": { education: 10, experience: 10, training: 10 },
      "related teaching": { education: 10, experience: 10, training: 10 },
      "higher teaching": { education: 10, experience: 10, training: 10 },
      "school administration": { education: 10, experience: 10, training: 10 },
      "non teaching": { education: 5, experience: 5, training: 20 }
    };

    // SG‐types loader (unchanged)
    const interviewTypeMap = {
      'teacher 1': 'TEACHING_POSITIONS',
      'related teaching': 'RELATED_TEACHING',
      'higher teaching': 'SCHOOL_ADMIN',
      'school administration': 'SCHOOL_ADMIN',
      'non teaching': 'NON_TEACHING'
    };
    let sgTypesData = null;
    async function loadSgTypes() {

      const r = await fetch("{{ url_for('static', filename='json/sg-type.json') }}");

      if (!r.ok) throw new Error(r.statusText);
      sgTypesData = await r.json();
    }
    function updateSgLevels(type) {
      const cat = interviewTypeMap[type],
        list = (cat && sgTypesData?.[cat]) || [];
      const container = document.getElementById('sg_level_container');
      const sel = document.getElementById('sg_level');
      sel.innerHTML = '<option disabled selected value="">– select –</option>';
      if (list.length) {
        container.style.display = 'block';
        list.forEach(p => {
          const txt = `${p.Position_Title} (SG ${p.Salary_Grade})`;
          const val = `${p.Position_Title};${p.Salary_Grade}`;
          sel.appendChild(new Option(txt, val));
        });
      } else {
        container.style.display = 'none';
      }
    }

    // NEW: set input.value and toggle visibility
    function updateWeights(type) {
      const w = WEIGHT_STRUCTURE[type] || null;

      const map = {
        weight_edu_container: { id: 'weight_edu', key: 'education' },
        weight_exp_container: { id: 'weight_exp', key: 'experience' },
        weight_trn_container: { id: 'weight_trn', key: 'training' }
      };

      Object.entries(map).forEach(([contId, { id, key }]) => {
        const ctr = document.getElementById(contId),
          inp = document.getElementById(id);
        if (w && w[key] != null) {
          ctr.style.display = 'block';
          inp.value = w[key];
        } else {
          ctr.style.display = 'none';
          inp.value = '';
        }
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try { await loadSgTypes(); }
      catch (e) { console.error(e); alert('SG load failed'); return; }

      const t = document.getElementById('interview_type');
      t.addEventListener('change', _ => {
        updateSgLevels(t.value);
        updateWeights(t.value);
      });

      // on-load sync if preselected
      if (t.value) {
        updateSgLevels(t.value);
        updateWeights(t.value);
      }
    });
  </script>


  <script>
    //Delete modal function.
    document.addEventListener('DOMContentLoaded', () => {
      const deleteModal = document.getElementById('delete-modal');
      const confirmDeleteBtn = document.getElementById('confirm-delete');
      const cancelDeleteBtn = document.getElementById('cancel-delete');

      // Show modal and stash URL in the confirm button
      document.querySelectorAll('a.confirm-delete').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          // store the link's href on the button
          confirmDeleteBtn.dataset.url = link.href;
          deleteModal.style.display = 'block';
        });
      });

      // If they click “Yes, delete”, go to that URL
      confirmDeleteBtn.addEventListener('click', () => {
        const url = confirmDeleteBtn.dataset.url;
        if (url) window.location.href = url;
      });

      // Cancel hides the modal
      cancelDeleteBtn.addEventListener('click', () => {
        deleteModal.style.display = 'none';
        confirmDeleteBtn.dataset.url = '';
      });

      // click outside or Escape also close
      deleteModal.addEventListener('click', e => {
        if (e.target === deleteModal) {
          deleteModal.style.display = 'none';
          confirmDeleteBtn.dataset.url = '';
        }
      });
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          deleteModal.style.display = 'none';
          confirmDeleteBtn.dataset.url = '';
        }
      });
    });

    //SEARCH BAR
    function filterInterviews() {
      const input = document.getElementById("searchBar").value.toLowerCase().trim();
      const rows = document.querySelectorAll(".qual-table tbody tr");

      rows.forEach(row => {
        let match = false;

        row.querySelectorAll("td").forEach(cell => {
          // Restore original HTML by removing previous highlights
          cell.innerHTML = cell.innerHTML.replace(/<span class="highlighted">(.*?)<\/span>/gi, '$1');

          const plainText = cell.textContent.toLowerCase();

          if (input && plainText.includes(input)) {
            match = true;

            // Highlight only text nodes, not HTML tags
            const regex = new RegExp(`(${input})`, "gi");
            const walker = document.createTreeWalker(cell, NodeFilter.SHOW_TEXT, null, false);

            let node;
            while ((node = walker.nextNode())) {
              const span = document.createElement("span");
              span.innerHTML = node.nodeValue.replace(regex, '<span class="highlighted">$1</span>');
              node.parentNode.replaceChild(span, node);
            }
          }
        });

        row.style.display = match || input === "" ? "" : "none";
      });
    }
    //SORT DATE
    let sortAsc = false; // Start with latest on top

    function sortByDate() {
      const tbody = document.querySelector(".qual-table tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));

      rows.sort((a, b) => {
        const dateA = new Date(a.children[1].textContent.trim());
        const dateB = new Date(b.children[1].textContent.trim());
        return sortAsc ? dateA - dateB : dateB - dateA;
      });

      rows.forEach(row => tbody.appendChild(row));
      sortAsc = !sortAsc;
    }
    // Sorted existing interview.
    document.addEventListener('DOMContentLoaded', function () {
      // Select the tbody of the existing interviews table
      const tbody = document.querySelector('.qual-table tbody');
      if (!tbody) return;

      // Grab all rows, reverse their order, and re-append them
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.reverse().forEach(row => tbody.appendChild(row));
    });
  </script>

</body>

</html>