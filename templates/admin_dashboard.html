<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Icons & Fonts -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Main stylesheet -->

  <link rel="icon" type="image/png" href="{{url_for('static', filename='./images/deped_seal.png')}}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='./css/admin_dashboard.css') }}" />
</head>

<body>

  <!-- SITE BANNER -->
  <header class="site-banner hide-on-scroll">
    <link rel="stylesheet" href="styles.css">
    <div class="banner-top">
      <!-- Logo and text -->
      <div class="banner-left-group">
        <img src="{{ url_for('static', filename='images/deped_seal.png') }}" alt="DepEd Logo" class="banner-logo" />
        <div class="banner-left-text">
          <p class="sub-banner-dept">Schools Division of Laoag City</p>
          <p class="sub-banner-region">Region I – Ilocos Region</p>
        </div>
      </div>
  
      <!-- Centered title -->
      <div class="banner-text">
        <h1>DEPARTMENT OF EDUCATION</h1>
        <p class="banner-subtitle">Human Resource Merit Promotion and Selection Board</p>

      </div>
    </div>
  </header>
  

  <!-- Logout Confirmation Modal -->
<div id="logout-modal" class="modal" style="display:none; flex-direction:column;">
  <div class="modal-content">
    <p>Are you sure you want to log out?</p>
    <div class="modal-actions">
      <button id="confirm-logout" class="btn-submit btn-submit--delete">
        Log out
      </button>
      <button id="cancel-logout" class="btn-submit btn-submit--view">
        Cancel
      </button>
    </div>
  </div>
</div>


  <!-- MAIN CONTAINER BOX -->
  <main class="form-container" role="main">

    <div class="tab-nav">
      <a href="#create_interview">Create Interview</a>
      <a href="#open_interview">Open Interview</a>
      <a href="#closed_interview">Closed Interviews</a>
        <!-- MOBILE VERSION -->
      <a href="{{ url_for('admin_logout') }}" class="btn logout-tab mobile-logout confirm-logout">Logout
      </a>
    </div>

    <div class="dashboard-box">

      {% with flashes = get_flashed_messages(
      with_categories=true,
      category_filter=["success", "error"]
   ) %}
  {% if flashes %}
    <div class="flash-msg-container">
      {% for category, text in flashes %}
        <div class="flash-{{ category }}">
          {{ text }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
      <!-- Create Interview Panel -->
      <section class="card panel-create" aria-labelledby="create-heading" id="create_interview">
        <h2 id="create-heading">Create Interview</h2>
        <form method="post" action="{{ url_for('create_interview') }}">

          <label for="interview_type">Interview Type</label>
          <select id="interview_type" name="interview_type" required>
            <option disabled selected>– select –</option>
            <option value="non teaching">Non-Teaching</option>
            <option value="teacher 1">Teacher 1</option>
            <option value="school administration">School Administration</option>
            <option value="related teaching">Related Teaching</option>
            <option value="higher teaching">Higher Teaching</option>
          </select>

          <!-- Add this after the interview_type select in your form -->
          <div id="sg_level_container" style="display: none;">
            <label for="sg_level">Job Group/SG-Level</label>
            <select id="sg_level" name="sg_level" required>
              <option disabled selected>– select –</option>
            </select>
          </div>


          <label for="baseline_education">Baseline Education</label>
          <select id="baseline_education" name="baseline_education" required>
            <option disabled selected>– select –</option>
            {% for k, v in ed_labels.items() %}
            <option value="{{ k }}">{{ v }}</option>
            {% endfor %}
          </select>

          <div id="weight_edu_container" style="display: none;">
            <label for="weight_edu">Weight Edu</label>
            <input type="number" id="weight_edu" name="weight_edu" min="0" step="5" required />
          </div>

          <label for="baseline_experience">Baseline Experience</label>
          <select id="baseline_experience" name="baseline_experience" required>
            <option disabled selected>– select –</option>
            {% for k, v in ex_labels.items() %}
            <option value="{{ k }}">{{ v }}</option>
            {% endfor %}
          </select>

          <div id="weight_exp_container" style="display: none;">
            <label for="weight_exp">Weight Experience</label>
            <input type="number" id="weight_exp" name="weight_exp" min="0" step="5" required />
          </div>

          <label for="baseline_training">Baseline Training</label>
          <select id="baseline_training" name="baseline_training" required>
            <option disabled selected>– select –</option>
            {% for k, v in tr_labels.items() %}
            <option value="{{ k }}">{{ v }}</option>
            {% endfor %}
          </select>

          <div id="weight_trn_container" style="display: none;">
            <label for="weight_trn">Weight Training</label>
            <input type="number" id="weight_trn" name="weight_trn" min="0" step="5" required />
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-submit">Create Interview</button>
          </div>
        </form>
      </section>

<!-- Open Interviews Panel -->
<section class="card panel-list" id="open_interview" aria-labelledby="open-heading">
  <h2 id="open-heading">Open Interviews</h2>
  <div class="interview-controls">
    <input type="text" id="searchBarOpen" placeholder="Search interview" onkeyup="filterInterviews('Open')">
    <button class="sort-btn" onclick="sortByDate('Open')">⇅ Sort by Date</button>
  </div>

  <!-- scrollable wrapper -->
  <div class="interview-list">
    <table class="qual-table" id="qual-tableOpen">
      <thead>
        <tr>
          <th>ID</th>
          <th>Type</th>
          <th>Date</th>
          <th>Baselines</th>
          <th>#Applicants</th>
          <th>Actions</th>      <!-- added -->
        </tr>
      </thead>
      <tbody>
        {% for iv in interviews if iv.status == "open" %}
        <tr>
          <td>{{ iv.id }}</td>
          <td>{{ iv.type }}</td>
          <td>{{ iv.date }}</td>
          <td>
            Education: {{ ed_labels[iv.base_edu ~ ''] }}<br>
            Experience: {{ ex_labels[iv.base_exp ~ ''] }}<br>
            Training: {{ tr_labels[iv.base_trn ~ ''] }}
          </td>
          <td>{{ iv.applicants|length }}</td>
          <td class="actions">
            <a href="{{ url_for('admin_interview_detail', iid=iv.id) }}"
               class="btn-submit btn-submit--view">View</a>
            <a href="{{ url_for('update_interview', iid=iv.id) }}"
               class="btn-submit btn-submit--update">Update</a>
            <a href="{{ url_for('delete_interview', iid=iv.id) }}"
               class="btn-submit btn-submit--delete confirm-delete">Delete</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>


<!-- Closed Interviews Panel -->
<section class="card panel-list" id="closed_interview" aria-labelledby="closed-heading">
  <h2 id="closed-heading">Closed Interviews</h2>
  <div class="interview-controls">
    <input type="text" id="searchBarClose" placeholder="Search interview" onkeyup="filterInterviews('Close')">
    <button class="sort-btn" onclick="sortByDate('Close')">⇅ Sort by Date</button>
  </div>

  <div class="interview-list">
    <table class="qual-table" id="qual-tableClose">
      <thead>
        <tr>
          <th>ID</th>
          <th>Date</th>
          <th>Baselines</th>
          <th>#Eval</th>
          <th>#Applicants</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for iv in interviews if iv.status == "close" %}
        <tr>
          <td>{{ iv.id }}</td>
          <td>{{ iv.date }}</td>
          <td>
            Education: {{ ed_labels[iv.base_edu ~ ''] }}<br>
            Experience: {{ ex_labels[iv.base_exp ~ ''] }}<br>
            Training: {{ tr_labels[iv.base_trn ~ ''] }}
          </td>
          <td>{{ iv.evaluator_tokens|length }}</td>
          <td>{{ iv.applicants|length }}</td>
          <td class="actions">
            <a href="{{ url_for('admin_interview_detail', iid=iv.id) }}"
               class="btn-submit btn-submit--view">View</a>
            <a href="{{ url_for('delete_interview', iid=iv.id) }}"
               class="btn-submit btn-submit--delete confirm-delete">Delete</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

  </main>

  <!-- SITE FOOTER -->
  <footer class="admin-footer">
    <div class="footer-content">
      <div class="footer-logos">
        <img src="{{ url_for('static', filename='images/deped_logo.png') }}" alt="DepEd Logo" />
      </div>
      <div class="footer-links">
        <a href="mailto:laoag.city@deped.gov.ph" title="Email">
          <i class="fas fa-envelope"></i> Email
        </a>
        <a href="https://www.facebook.com/depedtayolaoagcity" target="_blank" title="Facebook">
          <i class="fab fa-facebook-square"></i> Facebook
        </a>
        <a href="https://www.depedlaoagcity.com" target="_blank" title="Website">
          <i class="fas fa-globe"></i> Website
        </a>
      </div>
    </div>
  </footer>
  
  <script>
    // Static weight map
    const WEIGHT_STRUCTURE = {
      "teacher 1": { education: 10, experience: 10, training: 10 },
      "related teaching": { education: 10, experience: 10, training: 10 },
      "higher teaching": { education: 10, experience: 10, training: 10 },
      "school administration": { education: 10, experience: 10, training: 10 },
      "non teaching": { education: 5, experience: 5, training: 20 }
    };

    // SG‐types loader (unchanged)
    const interviewTypeMap = {
      'teacher 1': 'TEACHING_POSITIONS',
      'related teaching': 'RELATED_TEACHING',
      'higher teaching': 'SCHOOL_ADMIN',
      'school administration': 'SCHOOL_ADMIN',
      'non teaching': 'NON_TEACHING'
    };
    let sgTypesData = null;
    async function loadSgTypes() {

      const r = await fetch("{{ url_for('static', filename='json/sg-type.json') }}");

      if (!r.ok) throw new Error(r.statusText);
      sgTypesData = await r.json();
    }
    function updateSgLevels(type) {
      const cat = interviewTypeMap[type],
        list = (cat && sgTypesData?.[cat]) || [];
      const container = document.getElementById('sg_level_container');
      const sel = document.getElementById('sg_level');
      sel.innerHTML = '<option disabled selected value="">– select –</option>';
      if (list.length) {
        container.style.display = 'block';
        list.forEach(p => {
          const txt = `${p.Position_Title} (SG ${p.Salary_Grade})`;
          const val = `${p.Position_Title};${p.Salary_Grade}`;
          sel.appendChild(new Option(txt, val));
        });
      } else {
        container.style.display = 'none';
      }
    }

    // NEW: set input.value and toggle visibility
    function updateWeights(type) {
      const w = WEIGHT_STRUCTURE[type] || null;

      const map = {
        weight_edu_container: { id: 'weight_edu', key: 'education' },
        weight_exp_container: { id: 'weight_exp', key: 'experience' },
        weight_trn_container: { id: 'weight_trn', key: 'training' }
      };

      Object.entries(map).forEach(([contId, { id, key }]) => {
        const ctr = document.getElementById(contId),
          inp = document.getElementById(id);
        if (w && w[key] != null) {
          ctr.style.display = 'block';
          inp.value = w[key];
        } else {
          ctr.style.display = 'none';
          inp.value = '';
        }
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try { await loadSgTypes(); }
      catch (e) { console.error(e); alert('SG load failed'); return; }

      const t = document.getElementById('interview_type');
      t.addEventListener('change', _ => {
        updateSgLevels(t.value);
        updateWeights(t.value);
      });

      // on-load sync if preselected
      if (t.value) {
        updateSgLevels(t.value);
        updateWeights(t.value);
      }
    });
  </script>


  <script>
    //Delete modal function.
    document.addEventListener('DOMContentLoaded', () => {
      const deleteModal = document.getElementById('delete-modal');
      const confirmDeleteBtn = document.getElementById('confirm-delete');
      const cancelDeleteBtn = document.getElementById('cancel-delete');

      // Show modal and stash URL in the confirm button
      document.querySelectorAll('a.confirm-delete').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          // store the link's href on the button
          confirmDeleteBtn.dataset.url = link.href;
          deleteModal.style.display = 'block';
        });
      });

      // If they click “Yes, delete”, go to that URL
      confirmDeleteBtn.addEventListener('click', () => {
        const url = confirmDeleteBtn.dataset.url;
        if (url) window.location.href = url;
      });

      // Cancel hides the modal
      cancelDeleteBtn.addEventListener('click', () => {
        deleteModal.style.display = 'none';
        confirmDeleteBtn.dataset.url = '';
      });

      // click outside or Escape also close
      deleteModal.addEventListener('click', e => {
        if (e.target === deleteModal) {
          deleteModal.style.display = 'none';
          confirmDeleteBtn.dataset.url = '';
        }
      });
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          deleteModal.style.display = 'none';
          confirmDeleteBtn.dataset.url = '';
        }
      });
    });
  </script>

  <script>
    //SEARCH BAR
    function filterInterviews(type) {
      const input = document.getElementById("searchBar"+type).value.toLowerCase().trim();
      console.log("searchBar"+type)
      const rows = document.querySelectorAll("#qual-table"+type+" tbody tr");

      rows.forEach(row => {
        let match = false;

        row.querySelectorAll("td").forEach(cell => {
          // Restore original HTML by removing previous highlights
          cell.innerHTML = cell.innerHTML.replace(/<span class="highlighted">(.*?)<\/span>/gi, '$1');

          const plainText = cell.textContent.toLowerCase();

          if (input && plainText.includes(input)) {
            match = true;

            // Highlight only text nodes, not HTML tags
            const regex = new RegExp(`(${input})`, "gi");
            const walker = document.createTreeWalker(cell, NodeFilter.SHOW_TEXT, null, false);

            let node;
            while ((node = walker.nextNode())) {
              const span = document.createElement("span");
              span.innerHTML = node.nodeValue.replace(regex, '<span class="highlighted">$1</span>');
              node.parentNode.replaceChild(span, node);
            }
          }
        });

        row.style.display = match || input === "" ? "" : "none";
      });
    }
// SORT DATE
let sortAsc = {
  Open: false, // Track sort direction for Open Interviews
  Close: false // Track sort direction for Closed Interviews
};

function sortByDate(type) {
  const tableId = `#qual-table${type}`;
  const tbody = document.querySelector(`${tableId} tbody`);
  
  // Check if tbody exists
  if (!tbody) {
    console.error(`Table body for ${tableId} not found.`);
    return;
  }

  const rows = Array.from(tbody.querySelectorAll("tr"));
  const dateIndex = type === 'Open' ? 2 : 1; // Date column index for Open (2) or Close (1)

  rows.sort((a, b) => {
    const dateA = a.children[dateIndex].textContent.trim();
    const dateB = b.children[dateIndex].textContent.trim();

    // Attempt to parse dates (assuming YYYY-MM-DD or other standard format)
    const parsedDateA = new Date(dateA);
    const parsedDateB = new Date(dateB);

    // Handle invalid dates
    if (isNaN(parsedDateA) || isNaN(parsedDateB)) {
      console.warn(`Invalid date(s) in ${type} table: ${dateA}, ${dateB}`);
      // Fallback: compare as strings if dates are invalid
      return sortAsc[type] ? dateA.localeCompare(dateB) : dateB.localeCompare(dateA);
    }

    return sortAsc[type] ? parsedDateA - parsedDateB : parsedDateB - parsedDateA;
  });

  // Re-append sorted rows
  rows.forEach(row => tbody.appendChild(row));
  sortAsc[type] = !sortAsc[type];

  // Update button text to indicate sort direction
  const sortBtn = document.getElementById(`sortBtn${type}`);
  if (sortBtn) {
    sortBtn.textContent = `Sort by Date ${sortAsc[type] ? '↑' : '↓'}`;
  }
}

// Initial sorting for both tables
document.addEventListener('DOMContentLoaded', function () {
  ['Open', 'Close'].forEach(type => {
    const tableId = `#qual-table${type}`;
    const tbody = document.querySelector(`${tableId} tbody`);
    if (!tbody) {
      console.error(`Table body for ${tableId} not found during initial sort.`);
      return;
    }

    const dateIndex = type === 'Open' ? 2 : 1;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((a, b) => {
      const dateA = new Date(a.children[dateIndex].textContent.trim());
      const dateB = new Date(b.children[dateIndex].textContent.trim());
      if (isNaN(dateA) || isNaN(dateB)) {
        console.warn(`Invalid date(s) during initial ${type} sort: ${a.children[dateIndex].textContent}, ${b.children[dateIndex].textContent}`);
        return a.children[dateIndex].textContent.localeCompare(b.children[dateIndex].textContent);
      }
      return dateB - dateA; // Latest dates first
    });
    rows.forEach(row => tbody.appendChild(row));

    // Set initial button text
    const sortBtn = document.getElementById(`sortBtn${type}`);
    if (sortBtn) {
      sortBtn.textContent = `Sort by Date ↓`; // Indicate descending (latest first)
    }
  });
});
  </script>

  <script>// Logout modal logic
const logoutModal     = document.getElementById('logout-modal');
const btnLogoutYes    = document.getElementById('confirm-logout');
const btnLogoutCancel = document.getElementById('cancel-logout');
let pendingLogoutUrl  = null;

document.querySelectorAll('a.confirm-logout').forEach(link => {
  link.addEventListener('click', e => {
    e.preventDefault();
    pendingLogoutUrl = link.href;
    document.body.classList.add('modal-open');
    logoutModal.style.display = 'flex';
  });
});

btnLogoutYes.addEventListener('click', () => {
  document.body.classList.remove('modal-open');
  if (pendingLogoutUrl) window.location.href = pendingLogoutUrl;
});

btnLogoutCancel.addEventListener('click', () => {
  document.body.classList.remove('modal-open');
  logoutModal.style.display = 'none';
  pendingLogoutUrl = null;
});

logoutModal.addEventListener('click', e => {
  if (e.target === logoutModal) {
    document.body.classList.remove('modal-open');
    logoutModal.style.display = 'none';
    pendingLogoutUrl = null;
  }
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && logoutModal.style.display === 'flex') {
    document.body.classList.remove('modal-open');
    logoutModal.style.display = 'none';
    pendingLogoutUrl = null;
  }
});

let lastScrollTop = 0;
const footer = document.querySelector('.admin-footer');

window.addEventListener('scroll', () => {
  const st = window.pageYOffset || document.documentElement.scrollTop;
  if (st > lastScrollTop) {
    footer.classList.add('hidden');   // scroll down → hide
  } else {
    footer.classList.remove('hidden'); // scroll up → show
  }
  lastScrollTop = st <= 0 ? 0 : st;
});

</script>



</body>

</html>