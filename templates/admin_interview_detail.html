<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Interview {{ interview.id }} Details</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: 2rem auto; }
    a.btn { padding: .4rem .8rem; background: #007bff; color: #fff; text-decoration: none; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: .5rem; vertical-align: top; }
    th { background: #f4f4f4; }
    ul { margin: 0; padding-left: 1.2rem; }
    .no-data { color: #666; font-style: italic; }
    form { margin-top: 1rem; }
    label { display: block; margin: .5rem 0 .2rem; }
    input, select, button { width: 100%; padding: .4rem; margin-top: .5rem; }
    button { background: #28a745; color: #fff; border: none; border-radius: 4px; }
  </style>
</head>
<body>
  <a href="{{ url_for('admin_dashboard') }}" class="btn">← Back to Dashboard</a>
  <h1>Interview {{ interview.id }} Details</h1>
  <p><strong>Baselines:</strong> Edu {{ interview.base_edu }}, Exp {{ interview.base_exp }}, Trn {{ interview.base_trn }}</p>

  <!-- Section for Adding an Applicant -->
  <section>
    <h2>Add Applicant</h2>
    <form method="post" action="{{ url_for('add_applicant') }}">
      <input type="hidden" name="interview_id" value="{{ interview.id }}" required>
      <label>Applicant Code (optional)
        <input name="applicant_code" placeholder="Leave empty to auto-generate">
      </label>
      <label>Name<input name="name" required></label>
      <label>Address<input name="address" required></label>
      <label>Birthday<input type="date" name="birthday" required></label>
      <label>Age<input type="number" name="age" min="0" required></label>
      <label>Sex</label>
      <select name="sex" required>
        <option disabled selected>– select –</option>
        <option>Male</option>
        <option>Female</option>
        <option>Other</option>
      </select>
      <label>Raw Education</label>
      <select name="education" required>
        <option disabled selected>– select –</option>
        {% for k, v in ed_labels.items() %}
          <option value="{{ k }}">{{ v }}</option>
        {% endfor %}
      </select>
      <label>Raw Experience</label>
      <select name="experience" required>
        <option disabled selected>– select –</option>
        {% for k, v in ex_labels.items() %}
          <option value="{{ k }}">{{ v }}</option>
        {% endfor %}
      </select>
      <label>Raw Training</label>
      <select name="training" required>
        <option disabled selected>– select –</option>
        {% for k, v in tr_labels.items() %}
          <option value="{{ k }}">{{ v }}</option>
        {% endfor %}
      </select>
      <button type="submit">Add Applicant</button>
    </form>
  </section>

  <!-- Section for Adding Evaluator Tokens -->
  <section>
    <h2>Add Evaluator Token</h2>
    <form method="post" action="{{ url_for('generate_evaluator_tokens') }}">
      <input type="hidden" name="interview_id" value="{{ interview.id }}" required>
      <label>How many tokens?<input type="number" name="count_tokens" min="1" value="1" required></label>
      <button type="submit">Generate Tokens</button>
    </form>
  </section>

  <!-- Applicants Table with Scores Summary -->
  {% if applicants %}
    <h2>Applicants</h2>
    <table>
      <thead>
        <tr>
          <th>Code</th>
          <th>Name</th>
          <th>Address</th>
          <th>Birthday</th>
          <th>Age</th>
          <th>Sex</th>
          <th>Scores Summary</th>
          <th>Evaluator Comments</th>
        </tr>
      </thead>
      <tbody>
        {% for a in applicants %}
        <tr>
          <td>{{ a.code }}</td>
          <td>{{ a.name }}</td>
          <td>{{ a.address }}</td>
          <td>{{ a.birthday }}</td>
          <td>{{ a.age }}</td>
          <td>{{ a.sex }}</td>
          <td>
            <strong>Education:</strong> Raw: {{ a.raw_edu }}, Trans: {{ a.score_edu }}, 
            Actual: {{ ed_labels.get(a.raw_edu|string, "N/A") }}<br>
            <strong>Experience:</strong> Raw: {{ a.raw_exp }}, Trans: {{ a.score_exp }}, 
            Actual: {{ ex_labels.get(a.raw_exp|string, "N/A") }}<br>
            <strong>Training:</strong> Raw: {{ a.raw_trn }}, Trans: {{ a.score_trn }}, 
            Actual: {{ tr_labels.get(a.raw_trn|string, "N/A") }}
          </td>
          <td>
            {% if val_map[a.code] %}
              <ul>
                {% for v in val_map[a.code] %}
                  <li><strong>{{ v.evaluator_token }}:</strong> {{ v.comment or "(no comment)" }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <span class="no-data">No comments yet</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="no-data">No applicants added yet.</p>
  {% endif %}

  <!-- Evaluator Tokens Table -->
  <h2>Evaluator Tokens</h2>
  {% if eval_tokens %}
    <table>
      <thead>
        <tr>
          <th>Token</th>
          <th>Registration Status</th>
        </tr>
      </thead>
      <tbody>
        {% for et in eval_tokens %}
        <tr>
          <td>{{ et.token }}</td>
          <td>
            {% if et.registered %}
              Registered
            {% else %}
              Not Registered
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="no-data">No evaluator tokens generated yet.</p>
  {% endif %}
</body>
</html>
