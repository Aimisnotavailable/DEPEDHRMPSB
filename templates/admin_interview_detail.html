<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Interview {{ interview.id }} Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="{{url_for('static', filename='./images/deped_seal.png')}}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='./css/admin_interview_detail.css') }}">
</head>

<body>
  <!-- SITE BANNER -->
  <header class="site-banner" role="banner">
    <div class="banner-top">
      <!-- Left group: logo and text -->
      <div class="banner-left-group">
        <img src="{{ url_for('static', filename='images/deped_seal.png') }}" alt="DepEd Logo" class="banner-logo" />
        <div class="banner-left-text">
          <p class="sub-banner-dept">Schools Division of Laoag City</p>
          <p class="sub-banner-region">Region I – Ilocos Region</p>
        </div>
      </div>

      <!-- Centered title -->
      <div class="banner-text">
        <h1>DEPARTMENT OF EDUCATION</h1>
        <p class="banner-subtitle">Human Resource Merit Promotion and Selection Board</p>
      </div>
    </div>
  </header>



  <!-- CONTENT -->
  <main class="content-container" role="main">
    <h1>Interview {{ interview.id }} Details</h1>
    <p>
      <strong>Type:</strong> {{ interview.type.capitalize() }}<br>
      <strong>Salary Grade:</strong> {{ interview.sg_level.capitalize() }}<br>
      <strong>Baselines:</strong> <br> Education: {{ ed_labels[interview.base_edu|string] }} <br>
      Experience: {{ ex_labels[interview.base_exp|string] }} <br>
      Training: {{ tr_labels[interview.base_trn|string] }} <br>
    </p>

    <div class="tab-nav">
      <a href="{{ url_for('admin_dashboard') }}" class="btn">← Dashboard</a>
      <a href="#results">Results</a>
      <!-- <a href="#applicants">Applicants</a> -->
      <a href="#evaluators">Evaluators</a>
      {% if interview.status == "open" %}
      <a href="#add-applicant">Add Applicant</a>
      <a href="#add-token">Generate Tokens</a>

      <a href="{{ url_for('close_interview', iid=interview.id) }}" class="btn confirm-close">
        Close Interview
      </a>
      {% endif %}

    </div>

    <!-- Close Interview Confirmation Modal -->
    <div id="close-modal" class="modal" style="display:none;">
      <div class="modal-content">
        <p>Are you sure you want to close this interview?</p>
        <p>This action cannot be undone</p>
        <div class="modal-actions">
          <button id="confirm-close" class="btn-submit btn-submit--delete">
            Yes, close this interview
          </button>
          <button id="cancel-close" class="btn-submit btn-submit--view">
            Cancel
          </button>
        </div>
      </div>
    </div>


    <!-- APPLICANTS -->


    {% with flashes = get_flashed_messages(
    with_categories=true,
    category_filter=["success", "error"]
    ) %}
    {% if flashes %}
    <div class="flash-msg-container">
      {% for category, text in flashes %}
      <div class="flash-{{ category }}">
        {{ text }}
      </div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}



    <section id="results">
      <h2>Results</h2>
    
      {% if applicants %}
      <div class="sort-controls">
        <input type="text" id="searchBarResults" placeholder="Search Applicants" onkeyup="filterInterviews('Results')">
        <button class="sort-btn" onclick="sortByRank('Results')">⇅ Sort by Rank</button>
      </div>
      <!-- wrap only the table in this container -->
      <div class="table-container">
        <table class="detail-table" id="qual-tableResults">
          <thead>
            <tr>
              <th>RANK</th>
              <th>Code</th>
              <th>Name</th>
              <th>Score</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            {% for score in applicants_total_score %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ score[0] }}</td>
              <td>{{ score[1] }}</td>
              <td>{{ score[2] | round(2) }}</td>
              <td>
                <a href="{{ url_for('applicant_detail', code=score[0]) }}"
                   class="btn">View Details</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    
      <!-- other buttons (downloads) remain outside -->
      <a href="{{ url_for('download_interview_CAR', code=interview.id, f_type='with_name') }}"
         class="btn">Download CAR with name</a>
      <a href="{{ url_for('download_interview_CAR', code=interview.id, f_type='without_name') }}"
         class="btn">Download CAR without name</a>
      {% else %}
      <p>No applicants added yet.</p>
      {% endif %}
    </section>
    
    <!-- APPLICANTS
    <section id="applicants">
      <h2>Applicants</h2>
      <div class="sort-controls">
        <input type="text" id="searchBarApplicants" placeholder="Search Applicants"
          onkeyup="filterInterviews('Applicants')">
      </div>
      {% if applicants %}
      <table class="detail-table" id="qual-tableApplicants">
        <thead>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Detail</th>
          </tr>
        </thead>
        <tbody>
          {% for a in applicants %}
          <tr>
            <td>{{ a.code }}</td>
            <td>{{ a.name }}</td>
            <td>
              <a href="{{ url_for('applicant_detail', code=a.code) }}" class="btn">View Details</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No applicants added yet.</p>
      {% endif %}
    </section> -->

    <!-- EVALUATORS -->
    <section id="evaluators">
      <h2>Evaluators</h2>
      {% if eval_tokens %}
      <table class="detail-table">
        <thead>
          <tr>
            <th>Token</th>
            <th>Status</th>
            <th>Detail</th>
          </tr>
        </thead>
        <tbody>
          {% for et in eval_tokens %}
          <tr>
            <td>{{ et.token }}</td>
            <td>{{ 'Registered' if et.registered else 'Not Registered' }}</td>
            <td>
              <a href="{{ url_for('evaluator_detail', token=et.token) }}" class="btn">View Details</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p>No evaluator tokens generated yet.</p>
      {% endif %}
    </section>
    {% if interview.status == "open"%}
    <!-- Add Applicant Section -->
    <section id="add-applicant">
      <h2>Add Applicant</h2>
      <form method="post" action="{{ url_for('add_applicant') }}">
        <input type="hidden" name="interview_id" value="{{ interview.id }}" required>
        <label>Applicant Code (optional)
          <input name="applicant_code" placeholder="Leave empty to auto-generate">
        </label>
        <label>Name
          <input name="name" required>
        </label>
        <label>Address
          <input name="address" required>
        </label>
        <label>Contact Number
          <input minlength="11" maxlength="11" inputmode="numeric" type="tel" name="contact_number" required
            oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </label>
        <label>Email Address
          <input type="email" name="email_address" required>
        </label>
        <label>Birthday
          <input type="date" name="birthday" required>
        </label>
        <label>Age
          <input type="number" name="age" min="0" required>
        </label>
        <label>Sex</label>
        <select name="sex" required>
          <option disabled selected>– select –</option>
          <option>Male</option>
          <option>Female</option>
        </select>
        <label>Raw Education</label>
        <select name="education" required>
          <option disabled selected>– select –</option>
          {% for k, v in ed_labels.items() %}
          <option value="{{ k }}">{{ v }}</option>
          {% endfor %}
        </select>
        <label>Raw Experience</label>
        <select name="experience" required>
          <option disabled selected>– select –</option>
          {% for k, v in ex_labels.items() %}
          <option value="{{ k }}">{{ v }}</option>
          {% endfor %}
        </select>
        <label>Raw Training</label>
        <select name="training" required>
          <option disabled selected>– select –</option>
          {% for k, v in tr_labels.items() %}
          <option value="{{ k }}">{{ v }}</option>
          {% endfor %}
        </select>
        {% for k, v in applicant_structure.items() %}
        <label>{{ v['LABEL'] }} (MAX SCORE : {{ v['MAX_SCORE'] }} WEIGHT : {{ v['WEIGHT'] }})</label>
        <input type="number" name="{{ k }}" step="0.01" min="0" max="{{ v['MAX_SCORE'] }}" required>
        {% endfor %}
        <div class="form-actions">
          <button type="submit" class="btn-submit">Add Applicant</button>
        </div>
      </form>
    </section>

    <!-- GENERATE TOKENS -->
    <section id="add-token">
      <h2>Generate Evaluator Tokens</h2>
      <form method="post" action="{{ url_for('generate_evaluator_tokens') }}">
        <input type="hidden" name="interview_id" value="{{ interview.id }}">
        <label>How many tokens?
          <input type="number" name="count_tokens" min="1" value="1" required>
        </label>
        <div class="form-actions">
          <button type="submit" class="btn-submit">Generate Tokens</button>
        </div>
      </form>
    </section>
    {% endif %}
  </main>

  <!-- SITE FOOTER -->
  <footer class="admin-footer">
    <div class="footer-content">
      <div class="footer-logos">
        <img src="{{ url_for('static', filename='images/deped_logo.png') }}" alt="DepEd Logo" />
      </div>
      <div class="footer-links">
        <a href="mailto:laoag.city@deped.gov.ph" title="Email">
          <i class="fas fa-envelope"></i> Email
        </a>
        <a href="https://www.facebook.com/depedtayolaoagcity" target="_blank" title="Facebook">
          <i class="fab fa-facebook-square"></i> Facebook
        </a>
        <a href="https://www.depedlaoagcity.com" target="_blank" title="Website">
          <i class="fas fa-globe"></i> Website
        </a>
      </div>
    </div>
  </footer>

</body>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const closeModal = document.getElementById('close-modal');
    const confirmCloseBtn = document.getElementById('confirm-close');
    const cancelCloseBtn = document.getElementById('cancel-close');
    let pendingCloseUrl = null;

    // 1) Launcher: any link with .confirm-close
    document.querySelectorAll('a.confirm-close').forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        pendingCloseUrl = link.href;
        closeModal.style.display = 'flex';
      });
    });

    // 2) “Yes, close” navigates
    confirmCloseBtn.addEventListener('click', () => {
      if (pendingCloseUrl) window.location.href = pendingCloseUrl;
    });

    // 3) “Cancel” hides
    cancelCloseBtn.addEventListener('click', () => {
      closeModal.style.display = 'none';
      pendingCloseUrl = null;
    });

    // 4) clicking outside box or pressing Esc also cancels
    closeModal.addEventListener('click', e => {
      if (e.target === closeModal) {
        closeModal.style.display = 'none';
        pendingCloseUrl = null;
      }
    });
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && closeModal.style.display === 'flex') {
        closeModal.style.display = 'none';
        pendingCloseUrl = null;
      }
    });
  });
</script>

<script>
  //SEARCH BAR
  function filterInterviews(type) {
    const input = document.getElementById("searchBar" + type).value.toLowerCase().trim();
    console.log("searchBar" + type)
    const rows = document.querySelectorAll("#qual-table" + type + " tbody tr");

    rows.forEach(row => {
      let match = false;

      row.querySelectorAll("td").forEach(cell => {
        // Restore original HTML by removing previous highlights
        cell.innerHTML = cell.innerHTML.replace(/<span class="highlighted">(.*?)<\/span>/gi, '$1');

        const plainText = cell.textContent.toLowerCase();

        if (input && plainText.includes(input)) {
          match = true;

          // Highlight only text nodes, not HTML tags
          const regex = new RegExp(`(${input})`, "gi");
          const walker = document.createTreeWalker(cell, NodeFilter.SHOW_TEXT, null, false);

          let node;
          while ((node = walker.nextNode())) {
            const span = document.createElement("span");
            span.innerHTML = node.nodeValue.replace(regex, '<span class="highlighted">$1</span>');
            node.parentNode.replaceChild(span, node);
          }
        }
      });

      row.style.display = match || input === "" ? "" : "none";
    });
  }
  let sortAsc = false; // toggle asc/desc each click

  function sortByRank(type) {
    const tbody = document.querySelector(`#qual-table${type} tbody`);
    const rows = Array.from(tbody.querySelectorAll("tr"));

    rows.sort((a, b) => {
      // column 0 is the rank cell
      const rankA = parseInt(a.children[0].textContent.trim(), 10);
      const rankB = parseInt(b.children[0].textContent.trim(), 10);

      // ascending if sortAsc, else descending
      return sortAsc
        ? rankA - rankB
        : rankB - rankA;
    });

    // re‐append in new order
    rows.forEach(row => tbody.appendChild(row));

    sortAsc = !sortAsc;
  }
  // Sorted existing interview.
  document.addEventListener('DOMContentLoaded', function () {
    // Select the tbody of the existing interviews table
    const tbody = document.querySelector("#qual-table" + type + " tbody");
    if (!tbody) return;

    // Grab all rows, reverse their order, and re-append them
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.reverse().forEach(row => tbody.appendChild(row));
  });
  
</script>


</html>